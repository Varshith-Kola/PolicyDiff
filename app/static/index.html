<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolicyDiff — Privacy Policy &amp; ToS Change Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@14.1.4/marked.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/static/css/app.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen" x-data="policyDiffApp()" x-cloak>

<!-- Toast Notifications -->
<div class="fixed top-4 right-4 z-50 space-y-2">
    <template x-for="t in toasts" :key="t.id">
        <div class="toast flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg text-sm max-w-sm"
             :class="{
                'bg-green-900/90 text-green-200 border border-green-700': t.type === 'success',
                'bg-red-900/90 text-red-200 border border-red-700': t.type === 'error',
                'bg-blue-900/90 text-blue-200 border border-blue-700': t.type === 'info',
             }">
            <span x-text="t.message"></span>
        </div>
    </template>
</div>

<!-- Layout -->
<div class="flex min-h-screen">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col fixed h-full">
        <!-- Logo -->
        <div class="p-6 border-b border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-white">PolicyDiff</h1>
                    <p class="text-xs text-slate-400">Change Monitor</p>
                </div>
            </div>
        </div>

        <!-- Nav -->
        <nav class="flex-1 p-4 space-y-1">
            <button @click="navigate('dashboard')"
                    class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors"
                    :class="currentView === 'dashboard' ? 'bg-indigo-600/20 text-indigo-400' : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200'">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                </svg>
                Dashboard
            </button>
            <button @click="navigate('policies')"
                    class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors"
                    :class="currentView === 'policies' || currentView === 'policy-detail' ? 'bg-indigo-600/20 text-indigo-400' : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200'">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                Policies
                <span class="ml-auto bg-slate-700 text-slate-300 text-xs px-2 py-0.5 rounded-full" x-text="policies.length"></span>
            </button>
        </nav>

        <!-- Footer -->
        <div class="p-4 border-t border-slate-800">
            <button @click="checkAll()" :disabled="loading"
                    class="w-full flex items-center justify-center gap-2 px-3 py-2.5 bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 text-white rounded-lg text-sm font-medium transition-colors">
                <template x-if="loading"><span class="spinner"></span></template>
                <template x-if="!loading">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                </template>
                Check All Now
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 ml-64">

        <!-- ====== DASHBOARD VIEW ====== -->
        <div x-show="currentView === 'dashboard'" x-transition>
            <div class="p-8">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-white">Dashboard</h2>
                    <p class="text-slate-400 mt-1">Monitor your privacy policies and terms of service</p>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8" x-show="stats">
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5 card-hover">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-slate-400 text-sm">Monitored Policies</span>
                            <div class="w-8 h-8 rounded-lg bg-indigo-500/20 flex items-center justify-center">
                                <svg class="w-4 h-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            </div>
                        </div>
                        <p class="text-3xl font-bold text-white" x-text="stats?.total_policies || 0"></p>
                        <p class="text-xs text-slate-500 mt-1"><span x-text="stats?.active_policies || 0"></span> active</p>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5 card-hover">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-slate-400 text-sm">Snapshots Captured</span>
                            <div class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                                <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            </div>
                        </div>
                        <p class="text-3xl font-bold text-white" x-text="stats?.total_snapshots || 0"></p>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5 card-hover">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-slate-400 text-sm">Changes Detected</span>
                            <div class="w-8 h-8 rounded-lg bg-amber-500/20 flex items-center justify-center">
                                <svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                            </div>
                        </div>
                        <p class="text-3xl font-bold text-white" x-text="stats?.total_changes || 0"></p>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5 card-hover">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-slate-400 text-sm">Action Needed</span>
                            <div class="w-8 h-8 rounded-lg bg-red-500/20 flex items-center justify-center">
                                <svg class="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                        </div>
                        <p class="text-3xl font-bold text-white" x-text="stats?.action_needed_count || 0"></p>
                        <p class="text-xs text-slate-500 mt-1"><span x-text="stats?.concerning_count || 0"></span> concerning</p>
                    </div>
                </div>

                <!-- Recent Changes -->
                <div class="bg-slate-900 border border-slate-800 rounded-xl">
                    <div class="p-5 border-b border-slate-800">
                        <h3 class="text-lg font-semibold text-white">Recent Changes</h3>
                    </div>
                    <div x-show="stats?.recent_changes?.length > 0">
                        <template x-for="change in stats?.recent_changes || []" :key="change.id">
                            <div class="p-5 border-b border-slate-800/50 hover:bg-slate-800/30 transition-colors cursor-pointer"
                                 @click="navigate('diff-detail', change.id)">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-xs font-medium px-2 py-0.5 rounded-full border"
                                                  :class="severityColor(change.severity)"
                                                  x-text="change.severity"></span>
                                            <span class="text-xs text-slate-500" x-text="relativeTime(change.created_at)"></span>
                                        </div>
                                        <p class="text-sm text-slate-300 mt-1" x-text="change.summary || 'No summary available'"></p>
                                    </div>
                                    <svg class="w-5 h-5 text-slate-600 flex-shrink-0 ml-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div x-show="!stats?.recent_changes?.length" class="p-12 text-center">
                        <svg class="w-12 h-12 text-slate-700 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <p class="text-slate-500">No changes detected yet</p>
                        <p class="text-sm text-slate-600 mt-1">Add policies and run your first check</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ====== POLICIES VIEW ====== -->
        <div x-show="currentView === 'policies'" x-transition>
            <div class="p-8">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-white">Monitored Policies</h2>
                        <p class="text-slate-400 mt-1">Manage the pages you're tracking</p>
                    </div>
                    <button @click="showAddModal = true"
                            class="flex items-center gap-2 px-4 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        Add Policy
                    </button>
                </div>

                <!-- Policy Cards -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <template x-for="policy in policies" :key="policy.id">
                        <div class="bg-slate-900 border border-slate-800 rounded-xl p-5 card-hover">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1 cursor-pointer" @click="navigate('policy-detail', policy.id)">
                                    <h3 class="text-base font-semibold text-white" x-text="policy.name"></h3>
                                    <p class="text-sm text-slate-400" x-text="policy.company"></p>
                                </div>
                                <div class="flex items-center gap-1">
                                    <button @click="checkNow(policy.id)" :disabled="checking[policy.id]"
                                            class="p-2 rounded-lg text-slate-400 hover:text-indigo-400 hover:bg-slate-800 transition-colors disabled:opacity-50"
                                            title="Check now">
                                        <template x-if="checking[policy.id]"><span class="spinner"></span></template>
                                        <template x-if="!checking[policy.id]">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                                        </template>
                                    </button>
                                    <button @click="deletePolicy(policy.id)"
                                            class="p-2 rounded-lg text-slate-400 hover:text-red-400 hover:bg-slate-800 transition-colors"
                                            title="Delete">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 text-xs text-slate-500 mb-3 flex-wrap">
                                <span class="px-2 py-0.5 rounded bg-slate-800" x-text="policyTypeLabel(policy.policy_type)"></span>
                                <span x-show="policy.is_active" class="flex items-center gap-1">
                                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span> Active
                                </span>
                                <span x-show="!policy.is_active" class="flex items-center gap-1">
                                    <span class="w-1.5 h-1.5 rounded-full bg-slate-500"></span> Paused
                                </span>
                                <span x-show="seedStatusLabel(policy.seed_status)" class="px-2 py-0.5 rounded border text-[10px] font-medium" :class="seedStatusColor(policy.seed_status)" x-text="seedStatusLabel(policy.seed_status)"></span>
                            </div>
                            <div class="text-xs text-slate-600 truncate mb-3" x-text="policy.url"></div>
                            <div class="flex items-center justify-between text-xs text-slate-500 pt-3 border-t border-slate-800">
                                <span><span class="text-slate-300 font-medium" x-text="policy.snapshot_count"></span> snapshots</span>
                                <span x-show="policy.last_checked">Last checked <span x-text="relativeTime(policy.last_checked)"></span></span>
                                <span x-show="!policy.last_checked">Not checked yet</span>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Empty State -->
                <div x-show="policies.length === 0" class="text-center py-20">
                    <svg class="w-16 h-16 text-slate-700 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <h3 class="text-lg font-semibold text-slate-300 mb-2">No policies monitored yet</h3>
                    <p class="text-slate-500 mb-6">Add a privacy policy or terms of service URL to start monitoring</p>
                    <button @click="showAddModal = true"
                            class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition-colors">
                        Add Your First Policy
                    </button>
                </div>
            </div>
        </div>

        <!-- ====== POLICY DETAIL VIEW ====== -->
        <div x-show="currentView === 'policy-detail'" x-transition>
            <div class="p-8" x-show="currentPolicy">
                <!-- Back button + Header -->
                <div class="flex items-center gap-3 mb-6">
                    <button @click="navigate('policies')" class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold text-white" x-text="currentPolicy?.name"></h2>
                        <p class="text-slate-400 text-sm" x-text="currentPolicy?.company + ' — ' + currentPolicy?.url"></p>
                    </div>
                    <button @click="checkNow(currentPolicy.id)" :disabled="checking[currentPolicy?.id]"
                            class="flex items-center gap-2 px-4 py-2.5 bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 text-white rounded-lg text-sm font-medium transition-colors">
                        <template x-if="checking[currentPolicy?.id]"><span class="spinner"></span></template>
                        <template x-if="!checking[currentPolicy?.id]">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        </template>
                        Check Now
                    </button>
                    <button @click="seedWayback(currentPolicy.id)" :disabled="seeding[currentPolicy?.id] || currentPolicy?.seed_status === 'seeding'"
                            class="flex items-center gap-2 px-4 py-2.5 bg-emerald-700 hover:bg-emerald-600 disabled:opacity-50 text-white rounded-lg text-sm font-medium transition-colors">
                        <template x-if="seeding[currentPolicy?.id]"><span class="spinner"></span></template>
                        <template x-if="!seeding[currentPolicy?.id]">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </template>
                        Seed from Wayback
                    </button>
                    <button @click="showSeedModal = true"
                            class="flex items-center gap-2 px-4 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        Paste Snapshot
                    </button>
                    <button @click="openEditModal(currentPolicy)"
                            class="p-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors" title="Edit policy">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    </button>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <!-- Change History -->
                    <div class="xl:col-span-2">
                        <div class="bg-slate-900 border border-slate-800 rounded-xl">
                            <div class="p-5 border-b border-slate-800">
                                <h3 class="text-lg font-semibold text-white">Change History</h3>
                            </div>
                            <div x-show="diffs.length > 0">
                                <template x-for="d in diffs" :key="d.id">
                                    <div class="p-5 border-b border-slate-800/50 hover:bg-slate-800/30 transition-colors cursor-pointer"
                                         @click="navigate('diff-detail', d.id)">
                                        <div class="flex items-start gap-3">
                                            <div class="mt-0.5">
                                                <span class="w-3 h-3 rounded-full block severity-pulse" :class="severityDot(d.severity)"></span>
                                            </div>
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="text-xs font-medium px-2 py-0.5 rounded-full border" :class="severityColor(d.severity)" x-text="d.severity"></span>
                                                    <span class="text-xs text-slate-500" x-text="formatDate(d.created_at)"></span>
                                                </div>
                                                <p class="text-sm text-slate-300" x-text="d.summary || 'View diff for details'"></p>
                                                <div class="mt-2 flex flex-wrap gap-1">
                                                    <template x-for="change in parseKeyChanges(d.key_changes).slice(0, 3)" :key="change">
                                                        <span class="text-xs bg-slate-800 text-slate-400 px-2 py-0.5 rounded" x-text="change"></span>
                                                    </template>
                                                </div>
                                            </div>
                                            <svg class="w-5 h-5 text-slate-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            <div x-show="diffs.length === 0" class="p-12 text-center">
                                <p class="text-slate-500">No changes detected yet for this policy</p>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline & Snapshots -->
                    <div class="space-y-6">
                        <!-- Timeline -->
                        <div class="bg-slate-900 border border-slate-800 rounded-xl">
                            <div class="p-5 border-b border-slate-800">
                                <h3 class="text-base font-semibold text-white">Timeline</h3>
                            </div>
                            <div class="p-4 max-h-96 overflow-y-auto">
                                <div class="space-y-0">
                                    <template x-for="(entry, idx) in timeline" :key="idx">
                                        <div class="relative pl-8 pb-6">
                                            <div x-show="idx < timeline.length - 1" class="timeline-line"></div>
                                            <div class="absolute left-2 top-1 w-5 h-5 rounded-full border-2 flex items-center justify-center"
                                                 :class="entry.event_type === 'change' ? 'border-amber-400 bg-amber-400/20' : 'border-slate-600 bg-slate-800'">
                                                <span class="w-1.5 h-1.5 rounded-full" :class="entry.event_type === 'change' ? 'bg-amber-400' : 'bg-slate-500'"></span>
                                            </div>
                                            <div>
                                                <p class="text-xs text-slate-500" x-text="formatDate(entry.date)"></p>
                                                <p class="text-sm text-slate-300 mt-0.5" x-text="entry.summary || (entry.event_type === 'snapshot' ? 'Snapshot captured' : 'Change detected')"></p>
                                                <span x-show="entry.severity" class="text-xs font-medium px-1.5 py-0.5 rounded-full border mt-1 inline-block" :class="severityColor(entry.severity)" x-text="entry.severity"></span>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="timeline.length === 0" class="text-center py-6">
                                    <p class="text-sm text-slate-500">No activity yet</p>
                                </div>
                            </div>
                        </div>

                        <!-- Discovered Links -->
                        <div class="bg-slate-900 border border-slate-800 rounded-xl" x-show="snapshots.length > 0 && parseLinks(snapshots[0]?.discovered_links).length > 0">
                            <div class="p-5 border-b border-slate-800">
                                <h3 class="text-base font-semibold text-white">Discovered Subpages</h3>
                                <p class="text-xs text-slate-500 mt-1">Related policy pages found on this URL</p>
                            </div>
                            <div class="divide-y divide-slate-800/50 max-h-48 overflow-y-auto">
                                <template x-for="link in parseLinks(snapshots[0]?.discovered_links)" :key="link">
                                    <div class="p-3 px-5 text-xs">
                                        <a :href="link" target="_blank" class="text-indigo-400 hover:text-indigo-300 break-all" x-text="link"></a>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Snapshots -->
                        <div class="bg-slate-900 border border-slate-800 rounded-xl">
                            <div class="p-5 border-b border-slate-800">
                                <h3 class="text-base font-semibold text-white">Snapshots</h3>
                            </div>
                            <div class="divide-y divide-slate-800/50 max-h-64 overflow-y-auto">
                                <template x-for="s in snapshots" :key="s.id">
                                    <div class="p-3 px-5 flex items-center justify-between text-sm hover:bg-slate-800/30 cursor-pointer"
                                         @click="viewSnapshot(currentPolicy.id, s.id)">
                                        <div>
                                            <p class="text-slate-300 text-xs" x-text="formatDate(s.captured_at)"></p>
                                            <p class="text-slate-500 text-xs"><span x-text="s.content_length"></span> chars
                                                <span x-show="s.is_seed" class="text-indigo-400 ml-1">[seeded]</span>
                                            </p>
                                        </div>
                                        <span class="text-xs text-slate-600 font-mono" x-text="s.content_hash?.substring(0, 8) + '...'"></span>
                                    </div>
                                </template>
                            </div>
                            <div x-show="snapshots.length === 0" class="p-6 text-center">
                                <p class="text-sm text-slate-500">No snapshots yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ====== DIFF DETAIL VIEW ====== -->
        <div x-show="currentView === 'diff-detail'" x-transition>
            <div class="p-8" x-show="currentDiff">
                <!-- Back button + Header -->
                <div class="flex items-center gap-3 mb-6">
                    <button @click="navigate('dashboard')" class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <div>
                        <h2 class="text-2xl font-bold text-white">Change Analysis</h2>
                        <p class="text-slate-400 text-sm" x-text="'Diff #' + currentDiff?.id + ' — ' + formatDate(currentDiff?.created_at)"></p>
                    </div>
                </div>

                <!-- Severity + Summary Card -->
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 mb-6">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-sm font-semibold px-3 py-1 rounded-full border" :class="severityColor(currentDiff?.severity)" x-text="currentDiff?.severity?.toUpperCase()"></span>
                        <div class="flex items-center gap-1">
                            <div class="h-2 w-32 bg-slate-800 rounded-full overflow-hidden">
                                <div class="h-full rounded-full transition-all" 
                                     :class="{
                                        'bg-blue-500': currentDiff?.severity === 'informational',
                                        'bg-amber-500': currentDiff?.severity === 'concerning',
                                        'bg-red-500': currentDiff?.severity === 'action-needed',
                                     }"
                                     :style="'width:' + (currentDiff?.severity_score * 100) + '%'"></div>
                            </div>
                            <span class="text-xs text-slate-500" x-text="Math.round((currentDiff?.severity_score || 0) * 100) + '%'"></span>
                        </div>
                    </div>

                    <h3 class="text-lg font-semibold text-white mb-2">Summary</h3>
                    <p class="text-slate-300 leading-relaxed" x-text="currentDiff?.summary"></p>

                    <div class="mt-4 p-4 bg-indigo-500/10 border border-indigo-500/20 rounded-lg" x-show="currentDiff?.recommendation">
                        <h4 class="text-sm font-semibold text-indigo-400 mb-1">Recommendation</h4>
                        <p class="text-sm text-slate-300" x-text="currentDiff?.recommendation"></p>
                    </div>
                </div>

                <!-- Key Changes -->
                <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 mb-6" x-show="parseKeyChanges(currentDiff?.key_changes).length > 0">
                    <h3 class="text-lg font-semibold text-white mb-4">Key Changes</h3>
                    <div class="space-y-2">
                        <template x-for="(change, i) in parseKeyChanges(currentDiff?.key_changes)" :key="i">
                            <div class="flex items-start gap-3 p-3 bg-slate-800/50 rounded-lg">
                                <span class="w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center text-xs text-slate-300 flex-shrink-0 mt-0.5" x-text="i + 1"></span>
                                <p class="text-sm text-slate-300" x-text="change"></p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Clause Changes -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5">
                        <h4 class="text-sm font-semibold text-emerald-400 mb-3 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            Clauses Added
                        </h4>
                        <div class="space-y-2">
                            <template x-for="c in parseClauses(currentDiff?.clauses_added)" :key="c.section">
                                <div class="p-2 bg-emerald-500/10 rounded text-xs text-emerald-300" :class="c.significance_score >= 0.5 ? 'ring-1 ring-emerald-500/40' : ''">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-semibold" x-text="c.section"></span>
                                        <span x-show="c.significance_score > 0" class="text-[10px] px-1.5 py-0.5 rounded-full"
                                              :class="c.significance_score >= 0.5 ? 'bg-red-500/20 text-red-300' : c.significance_score >= 0.25 ? 'bg-amber-500/20 text-amber-300' : 'bg-slate-700 text-slate-400'"
                                              x-text="c.significance_score >= 0.5 ? 'HIGH' : c.significance_score >= 0.25 ? 'MED' : 'LOW'"></span>
                                    </div>
                                    <p class="text-emerald-400/70 mt-1 line-clamp-2" x-text="c.new_text"></p>
                                </div>
                            </template>
                            <p x-show="parseClauses(currentDiff?.clauses_added).length === 0" class="text-xs text-slate-500">None</p>
                        </div>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5">
                        <h4 class="text-sm font-semibold text-red-400 mb-3 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                            Clauses Removed
                        </h4>
                        <div class="space-y-2">
                            <template x-for="c in parseClauses(currentDiff?.clauses_removed)" :key="c.section">
                                <div class="p-2 bg-red-500/10 rounded text-xs text-red-300" :class="c.significance_score >= 0.5 ? 'ring-1 ring-red-500/40' : ''">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-semibold" x-text="c.section"></span>
                                        <span x-show="c.significance_score > 0" class="text-[10px] px-1.5 py-0.5 rounded-full"
                                              :class="c.significance_score >= 0.5 ? 'bg-red-500/20 text-red-300' : c.significance_score >= 0.25 ? 'bg-amber-500/20 text-amber-300' : 'bg-slate-700 text-slate-400'"
                                              x-text="c.significance_score >= 0.5 ? 'HIGH' : c.significance_score >= 0.25 ? 'MED' : 'LOW'"></span>
                                    </div>
                                    <p class="text-red-400/70 mt-1 line-clamp-2" x-text="c.old_text"></p>
                                </div>
                            </template>
                            <p x-show="parseClauses(currentDiff?.clauses_removed).length === 0" class="text-xs text-slate-500">None</p>
                        </div>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-5">
                        <h4 class="text-sm font-semibold text-amber-400 mb-3 flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            Clauses Modified
                        </h4>
                        <div class="space-y-2">
                            <template x-for="c in parseClauses(currentDiff?.clauses_modified)" :key="c.section">
                                <div class="p-2 bg-amber-500/10 rounded text-xs text-amber-300" :class="c.significance_score >= 0.5 ? 'ring-1 ring-amber-500/40' : ''">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-semibold" x-text="c.section"></span>
                                        <span x-show="c.significance_score > 0" class="text-[10px] px-1.5 py-0.5 rounded-full"
                                              :class="c.significance_score >= 0.5 ? 'bg-red-500/20 text-red-300' : c.significance_score >= 0.25 ? 'bg-amber-500/20 text-amber-300' : 'bg-slate-700 text-slate-400'"
                                              x-text="c.significance_score >= 0.5 ? 'HIGH' : c.significance_score >= 0.25 ? 'MED' : 'LOW'"></span>
                                    </div>
                                    <p class="text-amber-400/70 mt-1 line-clamp-2" x-text="c.new_text"></p>
                                </div>
                            </template>
                            <p x-show="parseClauses(currentDiff?.clauses_modified).length === 0" class="text-xs text-slate-500">None</p>
                        </div>
                    </div>
                </div>

                <!-- Side-by-Side Diff -->
                <div class="bg-slate-900 border border-slate-800 rounded-xl">
                    <div class="p-5 border-b border-slate-800">
                        <h3 class="text-lg font-semibold text-white">Side-by-Side Diff</h3>
                    </div>
                    <div class="overflow-auto max-h-[600px]" x-show="currentDiff?.diff_html">
                        <div x-html="currentDiff?.diff_html"></div>
                    </div>
                    <div class="p-8 text-center" x-show="!currentDiff?.diff_html">
                        <p class="text-slate-500">No diff content available</p>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<!-- ====== ADD POLICY MODAL ====== -->
<div x-show="showAddModal" x-transition.opacity class="fixed inset-0 z-40 flex items-center justify-center bg-black/60 backdrop-blur-sm" @click.self="showAddModal = false">
    <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-lg mx-4 shadow-2xl" @click.stop x-transition.scale.95>
        <div class="p-6 border-b border-slate-800">
            <h3 class="text-lg font-semibold text-white">Add Policy to Monitor</h3>
            <p class="text-sm text-slate-400 mt-1">Enter the URL of a privacy policy or terms of service page</p>
        </div>
        <div class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-1.5">Policy Name</label>
                <input type="text" x-model="newPolicy.name" placeholder="e.g. Google Privacy Policy"
                       class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-1.5">Company</label>
                <input type="text" x-model="newPolicy.company" placeholder="e.g. Google"
                       class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-1.5">URL</label>
                <input type="url" x-model="newPolicy.url" placeholder="https://policies.google.com/privacy"
                       class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1.5">Type</label>
                    <select x-model="newPolicy.policy_type"
                            class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
                        <option value="privacy_policy">Privacy Policy</option>
                        <option value="terms_of_service">Terms of Service</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1.5">Check Every</label>
                    <select x-model="newPolicy.check_interval_hours"
                            class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
                        <option value="6">6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24">24 hours</option>
                        <option value="72">3 days</option>
                        <option value="168">Weekly</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="p-6 border-t border-slate-800 flex justify-end gap-3">
            <button @click="showAddModal = false" class="px-4 py-2.5 text-sm text-slate-400 hover:text-slate-200 transition-colors">Cancel</button>
            <button @click="addPolicy()" :disabled="loading || !newPolicy.name || !newPolicy.url"
                    class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 text-white rounded-lg text-sm font-medium transition-colors">
                <template x-if="loading"><span class="spinner mr-2"></span></template>
                Add Policy
            </button>
        </div>
    </div>
</div>

<!-- ====== SEED SNAPSHOT MODAL ====== -->
<div x-show="showSeedModal" x-transition.opacity class="fixed inset-0 z-40 flex items-center justify-center bg-black/60 backdrop-blur-sm" @click.self="showSeedModal = false">
    <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-2xl mx-4 shadow-2xl" @click.stop x-transition.scale.95>
        <div class="p-6 border-b border-slate-800">
            <h3 class="text-lg font-semibold text-white">Seed Historical Snapshot</h3>
            <p class="text-sm text-slate-400 mt-1">Paste a previous version of this policy (e.g., from the Wayback Machine)</p>
        </div>
        <div class="p-6">
            <textarea x-model="seedContent" rows="12" placeholder="Paste the policy text here..."
                      class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm font-mono resize-none"></textarea>
        </div>
        <div class="p-6 border-t border-slate-800 flex justify-end gap-3">
            <button @click="showSeedModal = false" class="px-4 py-2.5 text-sm text-slate-400 hover:text-slate-200 transition-colors">Cancel</button>
            <button @click="seedSnapshot(selectedPolicyId)" :disabled="loading || !seedContent.trim()"
                    class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 text-white rounded-lg text-sm font-medium transition-colors">
                <template x-if="loading"><span class="spinner mr-2"></span></template>
                Seed Snapshot
            </button>
        </div>
    </div>
</div>

<!-- ====== SNAPSHOT VIEWER MODAL ====== -->
<div x-show="currentSnapshot" x-transition.opacity class="fixed inset-0 z-40 flex items-center justify-center bg-black/60 backdrop-blur-sm" @click.self="closeSnapshot()">
    <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-5xl mx-4 shadow-2xl max-h-[90vh] flex flex-col" @click.stop x-transition.scale.95>
        <div class="px-8 py-5 border-b border-slate-800 flex items-center justify-between flex-shrink-0">
            <div>
                <h3 class="text-lg font-semibold text-white">Snapshot Content</h3>
                <p class="text-sm text-slate-400" x-text="formatDate(currentSnapshot?.captured_at) + ' — ' + currentSnapshot?.content_length + ' chars'"></p>
            </div>
            <button @click="closeSnapshot()" class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="overflow-y-auto flex-1 px-8 py-6">
            <div class="policy-prose" x-html="renderMarkdown(currentSnapshot?.content_text)"></div>
        </div>
    </div>
</div>

<!-- ====== EDIT POLICY MODAL ====== -->
<div x-show="showEditModal" x-transition.opacity class="fixed inset-0 z-40 flex items-center justify-center bg-black/60 backdrop-blur-sm" @click.self="showEditModal = false">
    <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-lg mx-4 shadow-2xl" @click.stop x-transition.scale.95>
        <div class="p-6 border-b border-slate-800">
            <h3 class="text-lg font-semibold text-white">Edit Policy</h3>
        </div>
        <div class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-1.5">Policy Name</label>
                <input type="text" x-model="editPolicy.name"
                       class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-1.5">Company</label>
                <input type="text" x-model="editPolicy.company"
                       class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-1.5">URL</label>
                <input type="url" x-model="editPolicy.url"
                       class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1.5">Type</label>
                    <select x-model="editPolicy.policy_type"
                            class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
                        <option value="privacy_policy">Privacy Policy</option>
                        <option value="terms_of_service">Terms of Service</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-300 mb-1.5">Check Every</label>
                    <select x-model="editPolicy.check_interval_hours"
                            class="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-lg text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm">
                        <option value="6">6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24">24 hours</option>
                        <option value="72">3 days</option>
                        <option value="168">Weekly</option>
                    </select>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <label class="text-sm font-medium text-slate-300">Active</label>
                <button @click="editPolicy.is_active = !editPolicy.is_active"
                        class="relative w-10 h-5 rounded-full transition-colors"
                        :class="editPolicy.is_active ? 'bg-indigo-600' : 'bg-slate-700'">
                    <span class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform"
                          :class="editPolicy.is_active ? 'translate-x-5' : ''"></span>
                </button>
            </div>
        </div>
        <div class="p-6 border-t border-slate-800 flex justify-end gap-3">
            <button @click="showEditModal = false" class="px-4 py-2.5 text-sm text-slate-400 hover:text-slate-200 transition-colors">Cancel</button>
            <button @click="savePolicy()" :disabled="loading || !editPolicy.name || !editPolicy.url"
                    class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 text-white rounded-lg text-sm font-medium transition-colors">
                Save Changes
            </button>
        </div>
    </div>
</div>

<script src="/static/js/markdown.js"></script>
<script src="/static/js/app.js"></script>
</body>
</html>
